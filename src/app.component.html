<div class="relative w-full h-full bg-black overflow-hidden font-mono selection:bg-cyan-900 selection:text-white">
  <!-- FULL SCREEN VIEWPORT (Background Layer) -->
  <app-viewport [state]="gameState()" [imageSrc]="currentImage()" [loading]="isLoading()"
    [renderCharacters]="renderCharacters()" (interact)="handleInteraction($event)"
    (dialogueChoice)="handleDialogue($event)" class="absolute inset-0 z-0">
  </app-viewport>

  <!-- FIXED LOGO (Always Top Left) -->
  <div class="fixed top-4 left-4 z-[70] pointer-events-auto">
    <img src="/logo.png" alt="Vesper Project Apep"
      class="h-10 object-contain opacity-90 hover:opacity-100 transition-opacity">
  </div>

  <!-- UI OVERLAYS (Top Layer) -->
  <div class="absolute inset-0 z-10 pointer-events-none flex flex-col">

    <!-- Header Overlay -->
    <header
      class="h-24 bg-gradient-to-b from-black/80 to-transparent flex items-start justify-end p-4 pointer-events-auto">
      <!-- System Game Menu (Always Original) -->
      <app-game-menu (save)="saveGame()" (load)="loadGame()" (exit)="terminateSession()"
        (calibration)="startCalibration()" (changeCharacter)="handleCharacterChange($event)"
        (changeEnvironment)="changeEnvironment($event)" (toggleCharacters)="toggleCharacters()">
      </app-game-menu>
    </header>

    <!-- Middle Area (for Sidebar overlay) -->
    <div class="flex-1 flex justify-end relative overflow-hidden">
      <!-- Sidebar as Overlay -->
      <aside
        class="w-80 h-full bg-slate-950/90 backdrop-blur-md border-l border-slate-800 pointer-events-auto transition-transform duration-500"
        [style.transform]="isSidebarOpen() ? 'translateX(0)' : 'translateX(100%)'">

        <div class="flex-1 flex flex-col items-center justify-center p-6 text-slate-500">
          <div
            class="w-12 h-12 border border-slate-800 rounded-full flex items-center justify-center mb-4 animate-pulse">
            <span class="text-xs">AI</span>
          </div>
          <p class="text-[10px] tracking-widest uppercase opacity-50">Data Link Active</p>

          <!-- Debug Console inside Sidebar -->
          <div class="mt-auto w-full p-2 bg-black/40 border-t border-slate-800">
            <input type="text" [(ngModel)]="customInput" (keydown.enter)="submitCustomCommand()"
              placeholder="COMMAND..."
              class="w-full bg-transparent border-none outline-none text-cyan-500 font-mono text-[10px]">
          </div>
        </div>
      </aside>
    </div>

    <!-- Bottom Overlays -->
    <div class="h-28 pointer-events-none"></div>
  </div>

  <!-- Action Bar (Floating Overlay) -->
  @if (isMedievalEnvironment()) {
  <!-- Medieval Shield Action Bar (Bottom Right) -->
  <app-medieval-action-bar [items]="(inventoryService.items$ | async) || []" (actionSelected)="onActionSelected($event)"
    (inventoryToggled)="onInventoryToggled()">
  </app-medieval-action-bar>
  } @else {
  <!-- Standard Action Bar -->
  <app-action-bar (actionSelected)="onActionSelected($event)" (inventoryToggled)="onInventoryToggled()"
    class="z-50 pointer-events-none">
  </app-action-bar>
  }

  <!-- Inventory Panel (overlay) -->
  <app-inventory-panel [isOpen]="(inventoryService.isOpen$ | async) || false"
    [items]="(inventoryService.items$ | async) || []" (closed)="inventoryService.closeInventory()" class="z-[60]">
  </app-inventory-panel>

  <!-- VIDEO OVERLAY (Transition Cutscenes) -->
  @if (isVideoPlaying()) {
  <div class="absolute inset-0 z-[100] bg-black flex items-center justify-center animate-fadeIn">
    <video [src]="currentVideoSrc()" autoplay (ended)="onVideoEnded()" class="w-full h-full object-cover"></video>

    <!-- Optional Skip Button -->
    <button (click)="onVideoEnded()"
      class="absolute bottom-8 right-8 text-white/50 hover:text-white text-xs tracking-widest uppercase border border-white/20 px-4 py-2 rounded">
      Skip Sequence >>
    </button>
  </div>
  }

</div>