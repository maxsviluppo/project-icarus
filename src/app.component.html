<div class="flex flex-col h-screen bg-black text-slate-200 font-mono overflow-hidden selection:bg-cyan-900 selection:text-white">
  
  <!-- Header -->
  <header class="flex-none h-14 bg-slate-900 border-b border-slate-700 flex items-center justify-between px-6 z-30 shadow-md">
    <div class="flex items-center space-x-3">
      <div class="w-3 h-3 bg-amber-500 rounded-full animate-pulse shadow-[0_0_8px_rgba(245,158,11,0.8)]"></div>
      <h1 class="text-xl font-bold tracking-widest text-slate-100 font-[Orbitron]">VESPER<span class="text-amber-500 text-xs align-top ml-1">PROJ.APEP</span></h1>
      
      <!-- State Indicator (Debug) -->
      @if (gameState()?.storyState) {
        <span class="hidden md:inline-flex items-center ml-4 px-2 py-0.5 rounded bg-slate-800 text-[10px] text-cyan-400 border border-slate-700">
          STATE: {{ gameState()?.storyState }}
        </span>
      }
    </div>
    
    <div class="flex items-center space-x-4">
       <!-- Save/Load Controls -->
       <div class="flex space-x-1">
         <button (click)="saveGame()" class="px-2 py-1 bg-slate-800 hover:bg-slate-700 text-xs uppercase text-green-500 border border-slate-700 rounded transition-colors" title="Save Game">
           [SAVE]
         </button>
         <button (click)="loadGame()" class="px-2 py-1 bg-slate-800 hover:bg-slate-700 text-xs uppercase text-amber-500 border border-slate-700 rounded transition-colors" title="Load Game">
           [LOAD]
         </button>
       </div>

      <div class="text-xs text-slate-500 uppercase hidden sm:block">
        Secure Connection // <span class="text-cyan-500">ENCRYPTED</span>
      </div>
    </div>
  </header>

  <!-- Main Content Area -->
  <div class="flex-1 flex flex-col md:flex-row overflow-hidden relative">
    
    <!-- Left/Top Panel: Visual Viewport (Game Window) -->
    <main class="flex-1 relative bg-black p-2 md:p-4 flex flex-col min-h-[50vh] md:min-h-0 z-10">
      <app-viewport 
        [state]="gameState()" 
        [imageSrc]="currentImage()"
        [loading]="isLoading()"
        (interact)="handleInteraction($event)"
        (dialogueChoice)="handleDialogue($event)"
        class="flex-1 shadow-2xl"
      ></app-viewport>
    </main>

    <!-- Right/Bottom Panel: Terminal & Controls -->
    <aside class="w-full md:w-96 flex-none bg-slate-950 flex flex-col border-l border-slate-800 z-20">
      
      <!-- Inventory Bar -->
      <div class="p-3 bg-slate-900/50 border-b border-slate-800">
        <h3 class="text-xs text-slate-400 uppercase tracking-wider mb-2 flex justify-between">
          Inventory
          @if(selectedItem()) {
            <span class="text-amber-500 animate-pulse">USING: {{ selectedItem() }}</span>
          }
        </h3>
        <div class="flex flex-wrap gap-2">
          @if (inventory().length === 0) {
            <span class="text-xs text-slate-600 italic">Vuoto</span>
          }
          @for (item of inventory(); track item) {
            <button 
              (click)="selectItem(item)"
              class="px-2 py-1 border rounded text-xs shadow-sm transition-all"
              [class.bg-amber-900]="selectedItem() === item"
              [class.bg-slate-800]="selectedItem() !== item"
              [class.border-amber-500]="selectedItem() === item"
              [class.border-slate-600]="selectedItem() !== item"
              [class.text-amber-100]="selectedItem() === item"
              [class.text-slate-300]="selectedItem() !== item"
              [class.hover:border-cyan-500]="selectedItem() !== item"
            >
              {{ item }}
            </button>
          }
        </div>
      </div>

      <!-- Narrative Log -->
      <div class="flex-1 overflow-hidden relative">
        <app-terminal [logs]="logs()"></app-terminal>
      </div>

      <!-- Input Area -->
      <div class="p-3 bg-slate-900 border-t border-slate-700">
        <div class="flex space-x-2">
          <span class="text-cyan-500 self-center font-bold">></span>
          <input 
            type="text" 
            [(ngModel)]="customInput" 
            (keydown.enter)="submitCustomCommand()"
            [disabled]="isLoading()"
            placeholder="Comando manuale..."
            class="flex-1 bg-transparent border-none outline-none text-slate-200 placeholder-slate-600 font-mono h-10 focus:ring-0"
          >
          <button 
            (click)="submitCustomCommand()"
            [disabled]="!customInput() || isLoading()"
            class="px-4 bg-slate-800 hover:bg-cyan-900 text-cyan-400 text-xs font-bold rounded uppercase tracking-wider transition-colors disabled:opacity-30"
          >
            Invia
          </button>
        </div>
      </div>
    </aside>

  </div>
</div>